# Реализация системы бронирования ресурсов

## Что было сделано

### 1. Миграция базы данных
Создана миграция `2026_01_12_150453_add_booking_fields_to_events_table.php`, которая добавляет:
- `room_id` - связь с комнатой (опционально)
- `user_id` - связь с пользователем, который создал бронирование
- `status` - статус бронирования (pending, confirmed, cancelled, completed)
- `notes` - примечания к бронированию
- `price` - цена бронирования
- Индексы для оптимизации проверки пересечений времени

### 2. Модель Event
Обновлена модель `App\Models\Event`:
- Добавлены новые поля в `$fillable`
- Добавлены связи: `room()`, `user()`
- Добавлены scope-методы: `bookings()`, `roomBookings()`, `resourceBookings()`, `status()`
- Добавлены методы проверки: `isBooking()`, `isRoomBooking()`, `isResourceBooking()`
- Добавлен статический метод `isAvailable()` для проверки доступности ресурса/комнаты

### 3. Сервис BookingService
Создан сервис `App\Services\BookingService` с методами:
- `createBooking()` - создание бронирования
- `updateBooking()` - обновление бронирования
- `cancelBooking()` - отмена бронирования
- `confirmBooking()` - подтверждение бронирования
- `checkAvailability()` - проверка доступности
- `getAvailableTimeSlots()` - получение доступных временных слотов

### 4. MoonShine форма
Обновлена форма `EventFormPage`:
- Добавлено поле выбора комнаты (с фильтрацией по ресурсу)
- Добавлено поле выбора пользователя
- Добавлено поле выбора статуса
- Добавлено поле для цены
- Добавлено поле для примечаний

### 5. Переводы
Добавлены переводы для новых полей в `lang/ru/moonshine.php` и `lang/en/moonshine.php`

## Как использовать

### Запуск миграции
```bash
php artisan migrate
```

### Создание бронирования через сервис
```php
use App\Services\BookingService;

$bookingService = new BookingService();

$booking = $bookingService->createBooking([
    'name' => 'Бронирование зала',
    'description' => 'Описание события',
    'booked_resource_id' => 1, // ID ресурса
    'room_id' => 5, // ID комнаты (опционально)
    'user_id' => 1, // ID пользователя (по умолчанию берется из auth())
    'start_at' => '2026-01-15 10:00:00',
    'end_at' => '2026-01-15 12:00:00',
    'status' => 'pending',
    'price' => 5000.00,
    'notes' => 'Дополнительная информация',
]);
```

### Проверка доступности
```php
use App\Models\Event;

// Проверка доступности ресурса
$isAvailable = Event::isAvailable(
    resourceId: 1,
    startAt: '2026-01-15 10:00:00',
    endAt: '2026-01-15 12:00:00',
    roomId: null, // null = весь ресурс
    excludeEventId: null // при обновлении - ID текущего события
);

// Проверка доступности комнаты
$isRoomAvailable = Event::isAvailable(
    resourceId: 1,
    startAt: '2026-01-15 10:00:00',
    endAt: '2026-01-15 12:00:00',
    roomId: 5, // конкретная комната
);
```

### Получение бронирований
```php
use App\Models\Event;

// Все бронирования
$bookings = Event::bookings()->get();

// Бронирования с комнатами
$roomBookings = Event::roomBookings()->get();

// Бронирования ресурсов без комнат
$resourceBookings = Event::resourceBookings()->get();

// Бронирования по статусу
$pendingBookings = Event::status('pending')->get();
```

## Логика работы

### Бронирование ресурса без комнаты
- Указывается только `booked_resource_id`
- `room_id` остается `null`
- Бронируется весь ресурс целиком

### Бронирование комнаты
- Указывается `booked_resource_id` (родительский ресурс)
- Указывается `room_id` (конкретная комната)
- Бронируется только указанная комната

### Проверка пересечений
Система автоматически проверяет:
- Нельзя забронировать ресурс/комнату, если в это время уже есть активное бронирование
- Отмененные бронирования (`status = 'cancelled'`) не учитываются
- При обновлении бронирования текущее событие исключается из проверки

## Статусы бронирования

- `pending` - Ожидает подтверждения (по умолчанию)
- `confirmed` - Подтверждено
- `cancelled` - Отменено
- `completed` - Завершено

## Следующие шаги (опционально)

1. Добавить уведомления при создании/изменении бронирования
2. Создать API endpoints для фронтенда
3. Добавить календарь бронирований
4. Добавить возможность повторяющихся бронирований
5. Добавить систему оплаты

